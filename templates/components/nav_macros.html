{% macro main_nav(nav_notifications) -%}
  {% set user_id = session.get('user_id') %}
  {% set nav_data = nav_notifications or {} %}
  {% set nav_items = nav_data.get('items', []) %}
  {% set unread = nav_data.get('unread', 0) %}
  <nav class="navbar navbar-expand-lg">
    <div class="container-xxl">
      <a class="navbar-brand" href="{{ url_for('index') }}">
        <span class="brand-mark">BA</span>
        <span class="brand-text">BankApp</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div id="mainNav" class="collapse navbar-collapse justify-content-end">
        {% if user_id %}
        <ul class="navbar-nav align-items-lg-center gap-lg-3">
          <li class="nav-item dropdown">
            <a class="nav-link nav-icon position-relative" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Notifiche">
              <i class="bi bi-bell"></i>
              <span class="badge text-bg-danger badge-pill {% if not unread %}d-none{% endif %}">{{ unread or 0 }}</span>
            </a>
            <div class="dropdown-menu dropdown-menu-end shadow-lg notification-menu" aria-labelledby="notificationDropdown">
              <div class="dropdown-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold">Notifiche</span>
                <span class="badge text-bg-secondary">{{ unread or 0 }} nuove</span>
              </div>
              {% if nav_items %}
                {% for note in nav_items %}
                <a class="dropdown-item notification-item {{ 'is-unread' if note.status == 'UNREAD' else '' }}" href="{{ url_for('notifications_center') }}">
                  <div class="item-title">{{ note.title }}</div>
                  {% if note.body %}<div class="item-body">{{ note.body }}</div>{% endif %}
                </a>
                {% endfor %}
              {% else %}
                <span class="dropdown-item-text text-muted small">Nessuna notifica recente.</span>
              {% endif %}
              <div class="dropdown-divider"></div>
              <a class="dropdown-item text-center small" href="{{ url_for('notifications_center') }}">Apri centro notifiche</a>
            </div>
          </li>
          <li class="nav-item d-flex align-items-center gap-2">
            <div class="avatar-circle">{{ (session.get('display_name') or session.get('codice_cliente') or '?')[:1] }}</div>
            <div class="d-none d-lg-flex flex-column">
              <span class="fw-semibold">{{ session.get('display_name') or 'Profilo' }}</span>
              <span class="text-muted small">{{ session.get('codice_cliente') }}</span>
            </div>
          </li>
          <li class="nav-item">
            <a class="nav-link nav-icon" href="{{ url_for('settings') }}" aria-label="Impostazioni">
              <i class="bi bi-sliders"></i>
            </a>
          </li>
          <li class="nav-item">
            <form method="post" action="{{ url_for('logout') }}" class="d-inline">
              <button class="btn btn-ghost" type="submit">
                <i class="bi bi-box-arrow-right me-2"></i> Logout
              </button>
            </form>
          </li>
        </ul>
        {% else %}
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="btn btn-primary" href="{{ url_for('login') }}">Accedi</a>
          </li>
        </ul>
        {% endif %}
      </div>
    </div>
  </nav>
{%- endmacro %}

{% macro sub_nav(current_endpoint, links) -%}
  {% if session.get('user_id') and links %}
  <div class="app-subnav">
    <div class="container-xxl">
      <ul class="nav nav-underline gap-2">
        {% for link in links %}
        {% set match = link.match or link.endpoint %}
        {% set is_active = current_endpoint and current_endpoint.startswith(match) %}
        <li class="nav-item">
          {% if link.url %}
          <a class="nav-link {% if is_active %}active{% endif %}" href="{{ link.url }}">
            {% if link.icon %}<i class="bi {{ link.icon }} me-1"></i>{% endif %}{{ link.label }}
          </a>
          {% else %}
          <span class="nav-link disabled">{{ link.label }}</span>
          {% endif %}
        </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
{%- endmacro %}

