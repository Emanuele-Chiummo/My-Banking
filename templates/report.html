{% extends "base.html" %}
{% block title %}Report — BankApp{% endblock %}

{% block content %}
<section class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 report-section">
  <div>
    <h1 class="h4 mb-1">Report finanziario</h1>
    <p class="text-muted mb-0">Analisi ultimi {{ months }} {{ 'mesi' if months > 1 else 'mese' }} (dal {{ report.since }}).</p>
  </div>
  <form method="get" class="d-flex align-items-center gap-2" aria-label="Seleziona periodo di analisi">
    <label class="text-secondary small mb-0" for="reportMonths">Periodo</label>
    <select id="reportMonths" name="months" class="form-select form-select-sm" onchange="this.form.submit()">
      {% for m in [1,3,6,12] %}
      <option value="{{ m }}" {% if months == m %}selected{% endif %}>Ultimi {{ m }} {{ 'mesi' if m>1 else 'mese' }}</option>
      {% endfor %}
    </select>
  </form>
</section>

<section class="card card-gradient border-0 report-hero report-card report-section">
  <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-4">
    <div class="text-white">
      <span class="badge-soft badge-soft-light text-uppercase">Benessere finanziario</span>
      <h2 class="h3 mt-3 mb-2" id="scoreHeading">Punteggio complessivo: {{ report.score }} / 100</h2>
      <p class="mb-3 text-white-50">Il punteggio combina risparmio, stabilità delle spese e mesi di autonomia economica.</p>
      <dl class="report-pill-grid" aria-describedby="scoreHeading">
        <div class="report-pill" role="group" aria-label="Tasso di risparmio">
          <dt>Risparmio</dt>
          <dd>{{ report.components.savings_rate }}%</dd>
        </div>
        <div class="report-pill" role="group" aria-label="Runway normalizzato">
          <dt>Runway</dt>
          <dd>{{ report.components.runway_norm }}%</dd>
        </div>
        <div class="report-pill" role="group" aria-label="Stabilità delle spese">
          <dt>Stabilità spese</dt>
          <dd>{{ report.components.stability }}%</dd>
        </div>
        <div class="report-pill" role="group" aria-label="Copertura mesi stimata">
          <dt>Copertura media</dt>
          <dd>{{ report.totals.runway_months }} mesi</dd>
        </div>
      </dl>
    </div>
    <figure class="chart-figure report-gauge" aria-labelledby="scoreHeading" aria-describedby="scoreCaption">
      <canvas id="scoreGauge" aria-hidden="true" height="220"></canvas>
      <figcaption id="scoreCaption" class="text-white-50 small mt-2">Valore calcolato sui movimenti non legati ai salvadanai.</figcaption>
    </figure>
  </div>
</section>

<section class="card shadow-sm border-0 report-card report-section">
  <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start align-items-lg-center gap-3">
    <div>
      <h2 class="h5 mb-1">Indicatori principali</h2>
      <p class="text-muted mb-0">Valori aggregati per il periodo selezionato.</p>
    </div>
  </div>
  <div class="report-metric-grid mt-3" role="list">
    <article class="metric-tile" role="listitem" aria-label="Entrate totali">
      <span class="metric-label">Entrate totali</span>
      <span class="metric-value">{{ '%.2f'|format(report.totals.income) }} €</span>
      <span class="metric-subtle">Media mensile {{ '%.2f'|format(report.totals.avg_income) }} €</span>
    </article>
    <article class="metric-tile" role="listitem" aria-label="Uscite totali">
      <span class="metric-label">Uscite totali</span>
      <span class="metric-value">{{ '%.2f'|format(report.totals.expenses) }} €</span>
      <span class="metric-subtle">Media mensile {{ '%.2f'|format(report.totals.avg_expenses) }} €</span>
    </article>
    <article class="metric-tile" role="listitem" aria-label="Liquidità disponibile">
      <span class="metric-label">Liquidità</span>
      <span class="metric-value">{{ '%.2f'|format(report.totals.net_liquid) }} €</span>
      <span class="metric-subtle">Saldo conti + salvadanai attivi</span>
    </article>
    <article class="metric-tile" role="listitem" aria-label="Mesi di autonomia">
      <span class="metric-label">Runway stimata</span>
      <span class="metric-value">{{ '%.1f'|format(report.totals.runway_months) }}</span>
      <span class="metric-subtle">Mesi coperti al ritmo di spesa attuale</span>
    </article>
  </div>
</section>

<section class="row g-3 report-section">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm border-0 report-card h-100">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 class="h5 mb-1" id="incomeChartTitle">Entrate vs Uscite (mensile)</h2>
          <p class="text-muted small mb-0">Andamento per mese nel periodo selezionato.</p>
        </div>
        <span class="badge-soft">Dal {{ report.since }}</span>
      </div>
      <figure class="chart-figure mt-2" aria-labelledby="incomeChartTitle" aria-describedby="incomeChartCaption">
        <div class="chart-canvas-wrap">
          <canvas id="incomeExpensesChart" aria-hidden="true" height="240"></canvas>
        </div>
        <figcaption id="incomeChartCaption" class="text-muted small mt-2">
          Entrate totali {{ '%.2f'|format(report.totals.income) }} €, uscite {{ '%.2f'|format(report.totals.expenses) }} €.
        </figcaption>
      </figure>
      <span id="incomeTrendTitle" class="visually-hidden">Trend cumulato mensile entrate e uscite</span>
      <figure class="chart-figure mt-2" aria-labelledby="incomeTrendTitle" aria-describedby="incomeTrendCaption">
        <div class="chart-canvas-wrap chart-canvas-sm">
          <canvas id="incomeTrendChart" aria-hidden="true"></canvas>
        </div>
        <figcaption id="incomeTrendCaption" class="text-muted small mt-2">
          Linee cumulate per entrate e uscite, utili a confrontare il ritmo di crescita dei flussi.
        </figcaption>
      </figure>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm border-0 report-card h-100">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 class="h5 mb-1" id="categoryChartTitle">Spese per categoria</h2>
          <p class="text-muted small mb-0">Ripartizione dei costi principali.</p>
        </div>
        <span class="badge-soft">Ultimi {{ months }} {{ 'mesi' if months>1 else 'mese' }}</span>
      </div>
      <figure class="chart-figure mt-2" aria-labelledby="categoryChartTitle" aria-describedby="categoryChartCaption">
        <div class="chart-canvas-wrap chart-canvas-sm report-donut">
          <canvas id="categoryDonut" aria-hidden="true"></canvas>
        </div>
        <figcaption id="categoryChartCaption" class="text-muted small mt-2">
          Le categorie sono ordinate per spesa decrescente; l’elenco testo riporta gli importi esatti.
        </figcaption>
      </figure>
      <div class="row g-2 mt-2">
        <div class="col-12 col-md-6">
          <ul class="list-unstyled small mb-0 report-legend" id="cat-legend" aria-label="Legenda categorie"></ul>
        </div>
        <div class="col-12 col-md-6">
          <ul class="list-group small mb-0" id="cat-list" aria-label="Importi per categoria"></ul>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="row g-3 report-section">
  <div class="col-12 col-lg-6">
    <div class="card shadow-sm border-0 report-card h-100">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 class="h5 mb-1" id="cashflowChartTitle">Cash flow mensile</h2>
          <p class="text-muted small mb-0">Barre mensili con saldo progresso cumulato.</p>
        </div>
      </div>
      <figure class="chart-figure mt-2" aria-labelledby="cashflowChartTitle" aria-describedby="cashflowChartCaption">
        <div class="chart-canvas-wrap">
          <canvas id="cashflowChart" aria-hidden="true" height="240"></canvas>
        </div>
        <figcaption id="cashflowChartCaption" class="text-muted small mt-2">
          Barre verdi indicano mesi in attivo, quelle rosse mesi in perdita; la linea mostra il saldo cumulato.
        </figcaption>
      </figure>
    </div>
  </div>

  <div class="col-12 col-lg-6">
    <div class="card shadow-sm border-0 report-card h-100">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          <h2 class="h5 mb-1" id="savingsRateChartTitle">Tasso di risparmio mensile</h2>
          <p class="text-muted small mb-0">Percentuale di reddito trattenuta dopo le spese.</p>
        </div>
      </div>
      <figure class="chart-figure mt-2" aria-labelledby="savingsRateChartTitle" aria-describedby="savingsRateChartCaption">
        <div class="chart-canvas-wrap">
          <canvas id="savingsRateChart" aria-hidden="true" height="240"></canvas>
        </div>
        <figcaption id="savingsRateChartCaption" class="text-muted small mt-2">
          Il grafico evidenzia i mesi con maggiore capacità di risparmio; valori negativi indicano spesa superiore alle entrate.
        </figcaption>
      </figure>
    </div>
  </div>
</section>

<script id="report-data" type="application/json">{{ report|tojson }}</script>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="{{ url_for('static', filename='js/report.js') }}"></script>
{% endblock %}
