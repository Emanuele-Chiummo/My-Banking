{% extends "base.html" %}
{% block title %}Dashboard — Bank App{% endblock %}

{% block content %}
{% set main = accounts[0] if accounts else None %}
<section class="row g-4 align-items-stretch">
  <div class="col-12 col-lg-8">
    <div class="card card-gradient p-4 h-100">
      <div class="d-flex justify-content-between align-items-start gap-3">
        <div>
          <span class="subtle-text">Saldo principale</span>
          <div class="metric-value money" id="account-balance" data-raw="{{ '%.2f'|format(main['balance']) if main else '0.00' }}" data-currency="{{ main['currency'] if main else 'EUR' }}">
            {{ "%.2f"|format(main['balance']) if main else "0.00" }} {{ main['currency'] if main else "EUR" }}
          </div>
          {% if main %}
          <div class="subtle-text mt-1">{{ main['name'] }} &nbsp;•&nbsp; {{ main['iban'] }}</div>
          {% endif %}
        </div>
        <button class="btn toggle-visibility" id="toggle-visibility" type="button" aria-pressed="false" aria-label="Mostra/nascondi saldo">
          <i class="bi bi-eye"></i>
        </button>
      </div>
      <div class="d-flex flex-wrap gap-2 mt-4">
        <a class="btn btn-light btn-sm" href="{{ url_for('reports') }}">
          <i class="bi bi-graph-up-arrow me-1"></i>Report rapidi
        </a>
        <a class="btn btn-outline-light btn-sm" href="#transactions">
          <i class="bi bi-clock-history me-1"></i>Storico
        </a>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-4">
    <div class="card p-4 h-100">
      <span class="metric-label">Stato notifiche</span>
      <div class="metric-value">{{ unread_notifications or 0 }}</div>
      <p class="text-muted small mb-4">Ricevi alert automatici quando accadono eventi importanti.</p>
      <div class="d-flex flex-column gap-2">
        <a class="btn btn-primary" href="{{ url_for('notifications_center') }}">
          <i class="bi bi-bell me-2"></i> Apri centro notifiche
        </a>
        <a class="btn btn-outline-secondary" href="{{ url_for('settings') }}">
          <i class="bi bi-sliders me-2"></i> Preferenze alert
        </a>
      </div>
    </div>
  </div>
</section>

<section class="quick-actions">
  <a class="action" href="{{ url_for('p2p') }}">
    <div>
      <span class="badge-soft">P2P</span>
      <h3 class="h6 mt-3 mb-2">Invia denaro ai tuoi contatti</h3>
      <p class="text-muted mb-0">Gestisci gruppi, quote e trasferimenti in tempo reale.</p>
    </div>
    <i class="bi bi-arrow-up-right-circle fs-4 text-primary"></i>
  </a>
  <a class="action" href="#piggies">
    <div>
      <span class="badge-soft">Risparmio</span>
      <h3 class="h6 mt-3 mb-2">Controlla i tuoi salvadanai</h3>
      <p class="text-muted mb-0">Monitora progressi e stati direttamente da qui.</p>
    </div>
    <i class="bi bi-piggy-bank fs-4 text-primary"></i>
  </a>
  <a class="action" href="{{ url_for('reports') }}">
    <div>
      <span class="badge-soft">Insights</span>
      <h3 class="h6 mt-3 mb-2">Analisi personalizzate</h3>
      <p class="text-muted mb-0">Grafici e trend delle tue entrate/uscite.</p>
    </div>
    <i class="bi bi-bar-chart fs-4 text-primary"></i>
  </a>
</section>

<section class="row g-4" id="piggies">
  <div class="col-12 col-xl-6">
    <div class="card h-100 p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="h5 mb-1">Portafoglio</h2>
          <p class="text-muted mb-0">Distribuzione tra conto e risparmio.</p>
        </div>
        <div class="btn-group btn-group-sm" role="group">
          <button type="button" class="btn btn-outline-secondary active" id="btnAssetStacked">Barra 100%</button>
          <button type="button" class="btn btn-outline-secondary" id="btnAssetNone">Nascondi</button>
        </div>
      </div>
      <div id="assetChartWrap">
        <canvas id="assetChart" height="220"></canvas>
      </div>
      <div id="assetEmpty" class="text-muted text-center py-5 d-none">Grafico nascosto. Riattivalo per vedere la distribuzione.</div>
    </div>
  </div>
  <div class="col-12 col-xl-6">
    <div class="card h-100 p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="h5 mb-1">Notifiche recenti</h2>
          <p class="text-muted mb-0">Ultimi avvisi per tenere sotto controllo tutto.</p>
        </div>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('notifications_center') }}">Vedi tutte</a>
      </div>
      {% if notifications %}
      <ul class="notification-list list-group">
        {% for note in notifications[:4] %}
        <li class="list-group-item d-flex justify-content-between align-items-start gap-3 {% if note.status == 'UNREAD' %}notification-unread{% endif %}">
          <div>
            <div class="fw-semibold">{{ note.title }}</div>
            {% if note.body %}<div class="text-muted small">{{ note.body }}</div>{% endif %}
          </div>
          <span class="badge {{ 'text-bg-primary' if note.status == 'UNREAD' else 'text-bg-secondary' }} align-self-center">{{ note.status }}</span>
        </li>
        {% endfor %}
      </ul>
      {% else %}
      <p class="text-muted mb-0">Nessuna notifica al momento.</p>
      {% endif %}
    </div>
  </div>
</section>

<section class="row g-4">
  <div class="col-12">
    <div class="card p-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="h5 mb-1">Salvadanai</h2>
          <p class="text-muted mb-0">Monitora obiettivi di risparmio e stato attuale.</p>
        </div>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalCreatePiggy">
          <i class="bi bi-plus-lg me-1"></i>Nuovo salvadanaio
        </button>
      </div>
      {% if piggies %}
      <div class="row g-3">
        {% for p in piggies %}
        <div class="col-12 col-md-6 col-xl-4">
          <div class="card h-100 border-0 shadow-sm">
            <div class="card-body d-flex flex-column">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h3 class="h6 mb-1">{{ p['name'] }}</h3>
                  <span class="badge-soft">{{ p['status'] }}</span>
                </div>
                <span class="text-muted small">{{ "%.2f"|format(p['current_amount'] or 0) }} €</span>
              </div>
              <p class="text-muted small mb-2">Target {{ "%.2f"|format(p['target_amount'] or 0) }} €</p>
              <div class="piggy-progress" data-current="{{ p['current_amount'] or 0 }}" data-target="{{ p['target_amount'] or 0 }}">
                <div class="progress-bar" role="progressbar"></div>
              </div>
              <div class="d-flex flex-wrap gap-2 mt-3">
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTransfer" data-piggy="{{ p['piggy_id'] }}" data-current="{{ p['current_amount'] or 0 }}" data-direction="TO_PIGGY">Ricarica</button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalTransfer" data-piggy="{{ p['piggy_id'] }}" data-current="{{ p['current_amount'] or 0 }}" data-direction="FROM_PIGGY">Preleva</button>
                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="modal" data-bs-target="#modalDeletePiggy" data-piggy="{{ p['piggy_id'] }}" data-current="{{ p['current_amount'] or 0 }}">Elimina</button>
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center text-muted py-4">Nessun salvadanaio presente.</div>
      {% endif %}
    </div>
  </div>
</section>

<section class="row g-4" id="transactions">
  <div class="col-12">
    <div class="card p-4">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div>
          <h2 class="h5 mb-1">Transazioni recenti</h2>
          <p class="text-muted mb-0">Filtra, ordina e cerca in tempo reale.</p>
        </div>
        <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse" data-bs-target="#txFiltersCollapse" aria-expanded="false" aria-controls="txFiltersCollapse">
          <i class="bi bi-funnel"></i>
        </button>
      </div>
      <div class="collapse" id="txFiltersCollapse">
        <div class="rounded-4 p-3" style="background: rgba(67,83,255,0.07);">
          <div class="row g-2">
            <div class="col-12 col-md-4">
              <label class="form-label small" for="txSearch">Cerca</label>
              <input type="search" id="txSearch" class="form-control form-control-sm" placeholder="Descrizione o categoria">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txType">Tipo</label>
              <select id="txType" class="form-select form-select-sm">
                <option value="">Tutto</option>
                <option value="CREDIT">Entrate</option>
                <option value="DEBIT">Uscite</option>
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txAccount">Conto</label>
              <select id="txAccount" class="form-select form-select-sm">
                <option value="">Tutti</option>
                {% for a in accounts %}
                <option value="{{ a['account_id'] }}">{{ a['name'] or a['account_id'] }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txFrom">Dal</label>
              <input type="date" id="txFrom" class="form-control form-control-sm">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txTo">Al</label>
              <input type="date" id="txTo" class="form-control form-control-sm">
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txSort">Ordina per</label>
              <select id="txSort" class="form-select form-select-sm">
                <option value="date" selected>Data</option>
                <option value="amount">Importo</option>
                <option value="description">Descrizione</option>
                <option value="category">Categoria</option>
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txOrder">Ordine</label>
              <select id="txOrder" class="form-select form-select-sm">
                <option value="desc" selected>↓</option>
                <option value="asc">↑</option>
              </select>
            </div>
            <div class="col-6 col-md-2">
              <label class="form-label small" for="txLimit">Limite</label>
              <select id="txLimit" class="form-select form-select-sm">
                <option value="10" selected>10</option>
                <option value="20">20</option>
                <option value="50">50</option>
              </select>
            </div>
            <div class="col-12 col-md-4 d-flex gap-2 align-items-end">
              <button class="btn btn-primary btn-sm" id="txApply">Applica</button>
              <button class="btn btn-outline-secondary btn-sm" id="txReset">Reset</button>
            </div>
          </div>
        </div>
      </div>
      <div class="table-responsive mt-4">
        <table class="table table-modern align-middle">
          <thead>
            <tr>
              <th>Data</th>
              <th>Descrizione</th>
              <th>Categoria</th>
              <th>Conto</th>
              <th class="text-end">Importo</th>
            </tr>
          </thead>
          <tbody id="txTbody">
            {% for t in transactions %}
            <tr>
              <td>{{ t['date'] }}</td>
              <td>{{ t['description'] }}</td>
              <td>{{ t['category'] }}</td>
              <td>{{ t['account_name'] or t['account_id'] }}</td>
              <td class="text-end">
                {% if t['type'] == 'CREDIT' %}
                <span class="text-success">{{ "%.2f"|format(t['amount']) }} €</span>
                {% else %}
                <span class="text-danger">{{ "%.2f"|format(t['amount']) }} €</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div id="txEmpty" class="text-center text-muted py-4 d-none">Nessuna transazione trovata.</div>
      <div class="d-flex justify-content-between align-items-center mt-3">
        <button class="btn btn-outline-secondary btn-sm" id="txPrev">Indietro</button>
        <span id="txRangeLabel" class="text-muted small">Mostrando le ultime {{ transactions|length }} transazioni</span>
        <button class="btn btn-outline-secondary btn-sm" id="txNext">Avanti</button>
      </div>
    </div>
  </div>
</section>

<!-- Modals salvadanai -->
<div class="modal fade" id="modalCreatePiggy" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('web_piggy_create') }}">
      <div class="modal-header">
        <h5 class="modal-title">Nuovo salvadanaio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Nome</label>
          <input type="text" class="form-control" name="name" placeholder="Es. Vacanze 2026" required>
        </div>
        <div class="mb-3">
          <label class="form-label">Obiettivo (facoltativo)</label>
          <div class="input-group">
            <input type="number" step="0.01" min="0" class="form-control" name="target_amount" placeholder="Es. 1500.00">
            <span class="input-group-text">€</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annulla</button>
        <button class="btn btn-primary" type="submit">Crea</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modalTransfer" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('web_piggy_transfer') }}">
      <div class="modal-header">
        <h5 class="modal-title">Movimento salvadanaio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="piggy_id" id="transferPiggyId">
        <input type="hidden" name="direction" id="transferDirection">

        <div class="mb-3">
          <label class="form-label">Conto di appoggio</label>
          <select class="form-select" name="account_id" required>
            {% for a in accounts %}
            <option value="{{ a['account_id'] }}">{{ a['name'] or a['account_id'] }} — {{ a['iban'] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">Importo</label>
          <div class="input-group">
            <input id="transferAmount" type="number" step="0.01" min="0.01" class="form-control" name="amount" placeholder="0.00" required>
            <span class="input-group-text">€</span>
          </div>
          <div class="form-text">Usa "Ricarica" per versare, "Preleva" per rimuovere fondi.</div>
        </div>

        <div class="mb-3">
          <label class="form-label">Data</label>
          <input type="date" class="form-control" name="date">
        </div>

        <div class="mb-3">
          <label class="form-label">Nota (facoltativa)</label>
          <input type="text" class="form-control" name="note" placeholder="Es. accantonamento mensile">
        </div>

        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="create_account_tx" id="createAccountTx" checked>
          <label class="form-check-label" for="createAccountTx">Registra anche il movimento sul conto</label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annulla</button>
        <button class="btn btn-primary" type="submit">Salva movimento</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="modalDeletePiggy" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('web_piggy_delete') }}">
      <div class="modal-header">
        <h5 class="modal-title">Elimina salvadanaio</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" name="piggy_id" id="deletePiggyId">
        <p class="mb-2">Se è presente un saldo residuo, verrà riversato sul conto selezionato.</p>
        <div class="alert alert-info" role="alert">
          Saldo attuale: <strong id="deletePiggyBalance">0.00 €</strong>
        </div>
        <div class="mb-3">
          <label class="form-label">Conto di destinazione</label>
          <select class="form-select" name="account_id" required>
            {% for a in accounts %}
            <option value="{{ a['account_id'] }}">{{ a['name'] or a['account_id'] }} — {{ a['iban'] }}</option>
            {% endfor %}
          </select>
        </div>
        <p class="small text-muted mb-0">Questa azione non potrà essere annullata.</p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Annulla</button>
        <button class="btn btn-danger" type="submit">Elimina</button>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
  <script id="dash-data" type="application/json">{{ dash_payload|tojson }}</script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
  <script src="{{ url_for('static', filename='js/transactions.js') }}"></script>
{% endblock %}
